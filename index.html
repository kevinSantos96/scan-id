<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="style.css" />
    <title>Guía de centrado de objeto en cámara</title>
    <style>
      body {
        display: grid;
      }
      #content{
        width: auto;
        align-items: center;
        text-align: center;
      }
      #cameraContainer {
        position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
      }
      #guideMask {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 70%;
        height: 50%;
        border: 3px dashed greenyellow;
      }
      #capture-btn {
        display: inline-block;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        line-height: 50px;
        text-align: center;
        font-size: 18px;
        color: #fff;
        background-color: #007bff;
        border: none;
        cursor: pointer;
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.26);
      }
      #btnOpenCam{
        left: 50%;
        width: 50%;
        line-height: 2.5;
        margin: 10px auto 10px;
        background-color:#007bff; ;
        font-size: 14px;
        font-weight: 600;
        color: #fff;
        border: none;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.26);
      }
      #btnCloseCam{
        left: 50%;
        width: 50%;
        line-height: 2.5;
        margin: 10px auto 10px;
        background-color: orangered;
        font-size: 14px;
        font-weight: 600;
        color: #fff;
        border: none;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.26);
      }
    </style>
  </head>
  <body>
    <div id="content">
      <div>
        <button id="btnOpenCam">Abrir Camara</button>
        <button id="btnCloseCam" onclick="cerrarCamara()" style="display: none">
          Cerrar Camera
        </button>
      </div>
      <div id="cameraContainer" style="display: none">
        <video id="videoElement"  autoplay></video>
        <canvas id="overlayCanvas"></canvas>
        <div id="guideMask"></div>
        <button id="capture-btn"><i class="fa-solid fa-camera"></i></button>
      </div>
    </div>
    <script>
      var cmaeraContainer = document.getElementById("cameraContainer");
      var captureBtn = document.getElementById("capture-btn");
      var videoElement = document.getElementById("videoElement");

      const getCameraSelection = async () => {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(
          (device) => device.kind === "videoinput"
        );
        const options = videoDevices.map((videoDevice) => {
          return `<option value="${videoDevice.deviceId}">${videoDevice.label}</option>`;
        });
        cameraOptions.innerHTML = options.join("");
      };

      document
        .getElementById("btnOpenCam")
        .addEventListener("click", function () {
          //mostrar elementos en pantalla
          cmaeraContainer.style.display = "flex";
          document.getElementById("btnCloseCam").style.display = "block";
          document.getElementById("btnOpenCam").style.display = "none";
          //verifica los permisos
          if (
            "mediaDevices" in navigator &&
            "getUserMedia" in navigator.mediaDevices
          ) {
            //alert("tiene permiso");
            initCamera();
          } else {
            console.log("no tienes permiso");
          }
        });
      function cerrarCamara() {
        //mostar y ocultar elementos en pantalla
        cmaeraContainer.style.display = "none";
        document.getElementById("btnCloseCam").style.display = "none";
        document.getElementById("btnOpenCam").style.display = "block";
      }

      // pide los permisos
      function initCamera() {
        navigator.mediaDevices
          .getUserMedia({
            video: {
              width: {
                min: 1280,
              },
              height: {
                min: 720,
              },
              facingMode: "environment",
            },
          })
          .then((stream) => {
            videoElement.srcObject = stream;
            // videoElement.play();
          })
          .catch((err) => {
            console.error("Error accessing camera:", err);
            //alert(err.message);
          });
      }

      // Actualizar la posición de la máscara de guía
      function actualizarGuia(x, y) {
        var guia = document.getElementById("guideMask");
        guia.style.left = x + "px";
        guia.style.top = y + "px";
      }
      //tomar y guardar la foto
      captureBtn.addEventListener("click", function () {
        //si existe el elemento lo elimina
        if (document.getElementById("imgCapturada")) {
          document
            .querySelector("img")
            .parentNode.removeChild(document.querySelector("img"));
        }
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");
        canvas.width = videoElement.videoWidth;
        canvas.height = videoElement.videoHeight;
        context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
        console.log(canvas.toDataURL());

        // captura la imagen y la muestra en pantalla
        const capturedImage = new Image();
        capturedImage.setAttribute("id", "imgCapturada");
        capturedImage.src = canvas.toDataURL("image/png");
        document.body.appendChild(capturedImage);
      });
    </script>
  </body>
</html>
