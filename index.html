<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="style.css" />
    <title>Guía de centrado de objeto en cámara</title>
    <style>
      body {
        margin:0px;
        height: 100%;
      }
      #content{
        width: auto;
        align-items: center;
        text-align: center;
      }
      #cameraContainer {
        position: relative;
        width: auto;
        height: 100vh;
        /* margin: 0 auto; */
        /* border: 1px solid #000; */
        flex-direction: column;
      }
      #guideMask {
        position: absolute;
        top: 25rem;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        height: 25%;
        border: 3px dashed greenyellow;
      }
      #capture-btn {
        display: inline-block;
        border-radius: 50%;
        width: 80px;
        height: 80px;
        line-height: 50px;
        text-align: center;
        font-size: 35px;
        color: #fff;
        background-color: #007bff;
        border: none;
        cursor: pointer;
        position: absolute;
        top: 45rem;
        left: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.26);
      }
      #btnOpenCam{
        left: 50%;
        width: 50%;
        line-height: 2.5;
        margin: 10px auto 10px;
        background-color:#007bff; ;
        font-size: 14px;
        font-weight: 600;
        color: #fff;
        border: none;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.26);
      }
      #btnCloseCam{
        top: 0;
        left: 25%;
        width: 50%;
        line-height: 2.5;
        margin-top: 10px;
        background-color: orangered;
        position:absolute;
        font-size: 14px;
        font-weight: 600;
        color: #fff;
        border: none;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.26);
      }
      #videoElement{
        position: fixed;
        top: 0;
        left: 0;
        width: auto;
        height:90%;
        object-fit: cover;
      }
      #img_res{
        width: 98%;
        margin: auto;
      }
    </style>
  </head>
  <body>
    <div id="content">
      <div>
        <button id="btnOpenCam">Abrir Camara</button>
      </div>
      <div id="cameraContainer" style="display: none">
        <video id="videoElement"  autoplay></video>
        <canvas id="overlayCanvas"></canvas>
        <div id="guideMask"></div>
        <button id="capture-btn"><i class="fa-solid fa-camera"></i></button>
        <div> 
          <button id="btnCloseCam" onclick="cerrarCamara()" style="display: none;">
            Cerrar Camera
          </button>
        </div>
      </div>
      <div class="result-img">
          <img id="img_res" alt="img__res" style="display: none;" width="556" height="741"/>
      </div>
    </div>
    <script>
      var cmaeraContainer = document.getElementById("cameraContainer");
      var captureBtn = document.getElementById("capture-btn");
      var videoElement = document.getElementById("videoElement");
      var capturedImage = document.getElementById("img_res")

      const getCameraSelection = async () => {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(
          (device) => device.kind === "videoinput"
        );
        const options = videoDevices.map((videoDevice) => {
          return `<option value="${videoDevice.deviceId}">${videoDevice.label}</option>`;
        });
        cameraOptions.innerHTML = options.join("");
      };

      document
        .getElementById("btnOpenCam")
        .addEventListener("click", function () {
          //mostrar elementos en pantalla
          cmaeraContainer.style.display = "flex";
          document.getElementById("btnCloseCam").style.display = "block";
          document.getElementById("btnOpenCam").style.display = "none";
          capturedImage.src = "";
          capturedImage.style.display = "none";
          //verifica los permisos
          if (
            "mediaDevices" in navigator &&
            "getUserMedia" in navigator.mediaDevices
          ) {
            //alert("tiene permiso");
            initCamera();
          } else {
            console.log("no tienes permiso");
          }
        });
      function cerrarCamara() {
        //mostar y ocultar elementos en pantalla
        cmaeraContainer.style.display = "none";
        document.getElementById("btnCloseCam").style.display = "none";
        document.getElementById("btnOpenCam").style.display = "block";
        const tracks = videoElement.srcObject.getTracks();
        tracks[0].stop();
        videoElement.srcObject = null;
      }

      // pide los permisos
      function initCamera() {
        navigator.mediaDevices
          .getUserMedia({
            video: {
              width: {
                min: 1280,
              },
              height: {
                min: 720,
              },
              facingMode: "environment",
            },
          })
          .then((stream) => {
            videoElement.srcObject = stream;
            // videoElement.play();
          })
          .catch((err) => {
            console.error("Error accessing camera:", err);
            //alert(err.message);
          });
      }

      // Actualizar la posición de la máscara de guía
      function actualizarGuia(x, y) {
        var guia = document.getElementById("guideMask");
        guia.style.left = x + "px";
        guia.style.top = y + "px";
      }
      //tomar y guardar la foto
      captureBtn.addEventListener("click", function () {
        //si existe el elemento lo elimina
        if (document.getElementById("imgCapturada")) {
          document
            .querySelector("img")
            .parentNode.removeChild(document.querySelector("img"));
        }
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");
        canvas.width = videoElement.videoWidth;
        canvas.height = videoElement.videoHeight;
        context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
        //console.log(canvas.toDataURL()); //img base64
        alert("imagen guardada")

        // captura la imagen y la muestra en pantalla
        // const capturedImage = new Image();
        // capturedImage.setAttribute("id", "imgCapturada");
        capturedImage.src = canvas.toDataURL("image/png");
        cerrarCamara();
        capturedImage.style.display = "block";
        // document.body.appendChild(capturedImage);
      });
    </script>
  </body>
</html>
